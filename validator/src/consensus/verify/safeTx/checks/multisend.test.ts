import { zeroAddress } from "viem";
import { describe, expect, it, vi } from "vitest";
import { buildMultiSendCallOnlyCheck } from "./multisend.js";

describe("buildMultiSendCallOnlyCheck", () => {
	it("should decode and check sub-transactions from a valid multisend packet", async () => {
		const subCheck = vi.fn();
		const multiSendCheck = buildMultiSendCallOnlyCheck(subCheck);
		multiSendCheck({
			chainId: 1n,
			safe: "0xF01888f0677547Ec07cd16c8680e699c96588E6B",
			to: "0x40A2aCCbd92BCA938b02010E17A5b8929b49130D",
			value: 0n,
			data: "0x8d80ff0a0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000046b00469788fe6e9e9681c6ebf3bf78e7fd26fc01544600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044bd86e508736166652e657468000000000000000000000000000000000000000000000000000000000000000000000000d101ee8ab789b5ac467cd0c5343ac596e074e7a900a0b937d5c8e32a80e3a8ed4227cd020221544ee6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c4bf6213e4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000005bacaa20000000000000000000000000000000000000000000000017097071d7b566000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000109203d17922f539fb574e5e1f6d90465148bd7db15545841b8f3b4abe9df5d040e7dab6bf83b5e440418b27e82fcc724f0ff2dba673de766816c49b4c929b00c327b5754ca9c08cadb9ffdfe5a5207796d9be48d869dd0c500515774c0747e0087ffeb9bfa892a609ef0e4d8e56906cc226ebcdeed2e0956a1f8a510df63fa4704fa0478c551520b05243f319f13c8b0b2cd9fb5f6d2167906639eed96af45357c66521c5276873caaec751f783a1f5b8bf1a4721b6edddbe6f1c6461415f139915eb66ee9f44732b9861438a746c644967878a71a6242baa91d4487be75fb4cf0a6d3701dcb0b97559583b1aa2421882d56318b02c6c007abd359479775873df9fea2b42423550759e89e535b4d4e161e8fb2d863e5b60c01358a14197089be5b56c4486661ebec5747ec78d3ffac59923102c6a5d54c5defa08537873b7c82435fe35c5adc5c483754e6a5a344ae2ebdfa8c45aeaa13f577077674a91a947638b4fca97dbd562b4bce9c318eb9b985ea30aebe29cae941811e93425cc14762280ac2a9f69aebd287a893dc0efc0b5021b8ee3669877d200138fbf8fd4bb71fb64c7556587b8b27dd506cc48f6667566a8899de7a16e64f8c9c4c931bce8ebddc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470260ff1ff6ec89ea0b57028c682d3d1bdd86c9f393863a04e52b4b82ca363cbf700a0b937d5c8e32a80e3a8ed4227cd020221544ee6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000640087b83f5a5721848b2fa4cf4d2b8e3c7df9882952036c5ed24d31f5b1c71352252dcc93000000000000000000000000f01888f0677547ec07cd16c8680e699c96588e6b00000000000000000000000000000000ffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000",
			operation: 1,
			safeTxGas: 0n,
			baseGas: 0n,
			gasPrice: 0n,
			gasToken: zeroAddress,
			refundReceiver: zeroAddress,
			nonce: 0n,
		});
		expect(subCheck).toBeCalledTimes(3);
		expect(subCheck).toHaveBeenNthCalledWith(1, {
			chainId: 1n,
			safe: "0xF01888f0677547Ec07cd16c8680e699c96588E6B",
			to: "0x469788fE6E9E9681C6ebF3bF78e7Fd26Fc015446",
			value: 0n,
			data: "0xbd86e508736166652e657468000000000000000000000000000000000000000000000000000000000000000000000000d101ee8ab789b5ac467cd0c5343ac596e074e7a9",
			operation: 0,
			safeTxGas: 0n,
			baseGas: 0n,
			gasPrice: 0n,
			gasToken: zeroAddress,
			refundReceiver: zeroAddress,
			nonce: 0n,
		});
		expect(subCheck).toHaveBeenNthCalledWith(2, {
			chainId: 1n,
			safe: "0xF01888f0677547Ec07cd16c8680e699c96588E6B",
			to: "0xA0b937D5c8E32a80E3a8ed4227CD020221544ee6",
			value: 0n,
			data: "0xbf6213e4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000005bacaa20000000000000000000000000000000000000000000000017097071d7b566000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000109203d17922f539fb574e5e1f6d90465148bd7db15545841b8f3b4abe9df5d040e7dab6bf83b5e440418b27e82fcc724f0ff2dba673de766816c49b4c929b00c327b5754ca9c08cadb9ffdfe5a5207796d9be48d869dd0c500515774c0747e0087ffeb9bfa892a609ef0e4d8e56906cc226ebcdeed2e0956a1f8a510df63fa4704fa0478c551520b05243f319f13c8b0b2cd9fb5f6d2167906639eed96af45357c66521c5276873caaec751f783a1f5b8bf1a4721b6edddbe6f1c6461415f139915eb66ee9f44732b9861438a746c644967878a71a6242baa91d4487be75fb4cf0a6d3701dcb0b97559583b1aa2421882d56318b02c6c007abd359479775873df9fea2b42423550759e89e535b4d4e161e8fb2d863e5b60c01358a14197089be5b56c4486661ebec5747ec78d3ffac59923102c6a5d54c5defa08537873b7c82435fe35c5adc5c483754e6a5a344ae2ebdfa8c45aeaa13f577077674a91a947638b4fca97dbd562b4bce9c318eb9b985ea30aebe29cae941811e93425cc14762280ac2a9f69aebd287a893dc0efc0b5021b8ee3669877d200138fbf8fd4bb71fb64c7556587b8b27dd506cc48f6667566a8899de7a16e64f8c9c4c931bce8ebddc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470260ff1ff6ec89ea0b57028c682d3d1bdd86c9f393863a04e52b4b82ca363cbf7",
			operation: 0,
			safeTxGas: 0n,
			baseGas: 0n,
			gasPrice: 0n,
			gasToken: zeroAddress,
			refundReceiver: zeroAddress,
			nonce: 0n,
		});
		expect(subCheck).toHaveBeenNthCalledWith(3, {
			chainId: 1n,
			safe: "0xF01888f0677547Ec07cd16c8680e699c96588E6B",
			to: "0xA0b937D5c8E32a80E3a8ed4227CD020221544ee6",
			value: 0n,
			data: "0x0087b83f5a5721848b2fa4cf4d2b8e3c7df9882952036c5ed24d31f5b1c71352252dcc93000000000000000000000000f01888f0677547ec07cd16c8680e699c96588e6b00000000000000000000000000000000ffffffffffffffffffffffffffffffff",
			operation: 0,
			safeTxGas: 0n,
			baseGas: 0n,
			gasPrice: 0n,
			gasToken: zeroAddress,
			refundReceiver: zeroAddress,
			nonce: 0n,
		});
	});
});
